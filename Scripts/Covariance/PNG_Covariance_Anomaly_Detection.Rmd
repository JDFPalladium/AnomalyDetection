---
title: "PNG_Covariance_Anomaly_Detection"
output: html_document
---

# subset analyses we run in this file ------------------------------------------
# 1. overall - full dataset
# 2. sex - male and female
# 3. age (grouped by life stages - 0-14; 15+) (grouped by life stages - 0-14; 15-24; 25-49; 50+) (grouped by life stages - 0-14; 15-49; 50+)
# 4. facility type (clinic vs hospital)
# 5. key pop vs non key pop


# Set up Rmd -------------------------------------------
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load in libraries --------------------------------
```{r}
library(readr)
library(htmltools)
library(dplyr)
library(knitr)
library(tidyr)
library(modi)
library(htmltools)
library(magrittr)
library(openxlsx)
library(readxl)
```


# Prepare the data ----------------------------
```{r}
# Importing MER data
setwd("C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection")
filepath <- "C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection/"
mer_png_raw <- read.csv(paste0(filepath, "PNG FY20 Q1 MER Data Release for Data.FI_4.13.2021.csv"), stringsAsFactors = FALSE)

# only keep rows for which there is more than one unique value
cols_to_keep <- c(1,2,20,21,23,24,25,27,28,29,30,31,32,33,34,35,36,37,38,39,40,49)
mer_png <- mer_png_raw[, cols_to_keep]

# remove the rows that report on Total Numerator or Total Denominator data
mer_png_full <- mer_png %>% filter(!disaggregate %in% c("Total Numerator", "Total Denominator"),
                                   numeratordenom == "N",
                                   !is.na(qtr1))

# create a column for the key population disaggregate
mer_png_full <- mer_png_full %>% 
  mutate(kp = ifelse(disaggregate == "KeyPop/Result" | disaggregate == "KeyPop/HIVStatus", "Yes", "No"))

# create a column for the facility type disaggregate
mer_png_full <- mer_png_full %>% 
  mutate(facility_type = ifelse(facility == "Gerehu Hospital", "Hospital", "Clinic"))

# covert type of the columns to factor
mer_png_full$facility <- as.factor(mer_png_full$facility)
mer_png_full$indicator <- as.factor(mer_png_full$indicator)
mer_png_full$disaggregate <- as.factor(mer_png_full$disaggregate)
mer_png_full$sex <- as.factor(mer_png_full$sex)
mer_png_full$ageasentered <- as.factor(mer_png_full$ageasentered)
mer_png_full$kp <- as.factor(mer_png_full$kp)
mer_png_full$facility_type <- as.factor(mer_png_full$facility_type)

# group by facility, age, sex, and indicator, and then summarize qtr 1 (before pivot)
mer_png_full <- mer_png_full %>% group_by(facility, ageasentered, sex, indicator, kp, facility_type) %>% 
  summarise(qtr1sum = sum(qtr1, na.rm = TRUE)) 

# pivot wider
mer_png_full_tidy <- mer_png_full %>%
  pivot_wider(names_from = "indicator", values_from = "qtr1sum")
mer_png_full_processed <- mer_png_full_tidy

mer_png_full_processed[mer_png_full_processed == 0] <- NA

write.xlsx(mer_png_full_processed, file = "mer_png_full.xlsx")

```


# Read in the data ----------------------------
```{r}
setwd("C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection")
filepath <- "C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection/"

mer_png_full <- read_excel("mer_png_full.xlsx")

```


# All - facility name, age, sex, kp, and facility type -----------------------------------------
# summary: useful output
# sparsity: cols_to_keep at least 5%
# obs_to_keep using obs_count > 2
# drops due to no variance: none
# drops due to colinearity: none
```{r}
# drop observations where most variables are missing and variables where most observations are missing; this section deals with sparsity
site_spread <- mer_png_full
obs_count <- apply(site_spread[, 6:ncol(site_spread)], 1, function(x) length(which(!is.na(x)))) # drops the facilities for which all values are missing
count_present <- apply(site_spread[, 6:ncol(site_spread)], 2, function(x) length(which(!is.na(x)))) # tells us how many rows have each indicator reported
cols_to_keep <- which(count_present > (nrow(site_spread)*.05))+5 # keep variables present at least 5% of the time (was originally 10%)
obs_to_keep <- which(obs_count > 2) # keep observations with at least one present values (was originally 4)
site_keep <- cbind(site_spread[obs_to_keep, 1:5], site_spread[obs_to_keep, cols_to_keep])

# calculate variance of each indicator; if 0, drop it
# calculate colinearity between variable pairs; if a pair is colinear, drop one of them

# get sparse mu (vector of means)
# alternatively use g sub to replace commas with blanks, the convert using as numeric
sum_sparse <- colSums(site_keep[, 6:ncol(site_keep)], na.rm = TRUE) # sum of present values by variable; use na.rm so we remove NAs
count_present_keep <- apply(site_keep[, 6:ncol(site_keep)], 2, function(x) length(which(!is.na(x))))
# count_present_keep <- count_present[cols_to_keep-5] # count of present values by variable
mu <- sum_sparse / count_present_keep # means
k <- length(mu) # number of variables (indicators)

N <- matrix(0, k, k) # set up k by k matrix; the diagonal is the number of observations; look at the paper
diag(N) <- count_present_keep # diagonal initiated with count of present values

i_mat <- matrix(0, k, k) # set up identity matrix
diag(i_mat) <- 1

S <- matrix(0, k, k) # N is the counts, s is where we store the covariances, and I is useful for some calculations

for (i in 1:nrow(site_keep)){
  dat <- site_keep[i, ]
  inds <- which(!is.na(dat[6:ncol(site_keep)])) # inds returns the index of the columns that have non NA values
  yt <- dat[6:ncol(site_keep)][inds] # yt are the actual values that are associated with the indices in inds
  yt_mu <- as.matrix(yt - mu[inds]) # yt_mu subtracts the mu for each indicator from yt for each indicator
  
  Hyt <- as.matrix(i_mat[inds, ]) # hyt is a matrix that has the number of present values as rows and the numbers of all variables as columns
  if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)} #this relevant if we set the threshold too high and we only have 1 indicator column coming through
  
  S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
}

N_sqrt <- sqrt(N)
diag(N_sqrt) <- 1/(diag(N_sqrt))
R <- (N_sqrt %*% S %*% N_sqrt)

# Calculate Mahalanobis distance
site_sparse <- site_keep
site_sparse$MD_sp <- MDmiss(site_sparse[, 6:ncol(site_sparse)], center = mu, cov = R)
cv<-qchisq(.95,df=ncol(site_sparse)-1)
site_sparse$outlier_sp <- ifelse(site_sparse$MD_sp>cv, 1, 0)

# Predict present values - xt is the value to predict, yt are the other present values
# value will be Rxtyt %*% Ryt_inv %*% yt-uyt + uxt
preds <- matrix(data = NA, nrow = nrow(site_keep), ncol = k) # set up matrix to hold estimates

# Loop through each row
for (i in 1:nrow(site_keep)){
 
  # Get present values and index of present values
  dat <- site_keep[i, ]
  inds <- which(!is.na(dat[6:ncol(site_keep)]))
  
  # loop through index of present values
  for (j in inds){
    
    # Get Rxtyt - covariance of other present values with selected present values
    Rxtyt <- R[j, inds[!(inds %in% j)]]
    # Get Ryt_inv
    Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
    if (length(Ryt) > 1){
    Ryt_inv <- matlib::inv(Ryt)  
    } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
    #Get yt-uyt
    yt <- dat[6:ncol(site_keep)][inds[!(inds %in% j)]]
    yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
    # uxt
    uxt <- mu[j]
    
    # Get estimated value
    preds[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
    
  }
   
  
}

preds_df <- data.frame(preds)
names(preds_df) <- paste0("E_", names(site_sparse)[6:17])
site_all <- cbind(site_sparse, preds_df)

# Take the difference between estimate and actual and normalize by dividing by sample variance
deviation <- abs(site_all[, 20:31] - site_all[, 6:17])
deviation <- mapply('/', deviation, diag(R))
deviation <- data.frame(deviation)
names(deviation) <- paste0("D_", names(site_sparse)[6:17])
site_out_total <- cbind(site_all, deviation)

write.xlsx(site_out_total, file = "png_total_anomaly_recommender.xlsx")

# left join the output table from the sex run to site_spread (join on all five of the unique columns)
site_out_total_full <- left_join(site_spread[,c("facility", "ageasentered", "sex", "kp", "facility_type")], site_out_total, by=c("facility", "ageasentered", "sex", "kp", "facility_type"))

write.xlsx(site_out_total_full, file = "png_total_anomaly_recommender_full.xlsx")
```


# Let's split the data by sex and run on each sub-group ------------------------
# summary: useful output
# sparsity: cols_to_keep at least 10%
# obs_to_keep using obs_count > 3
# drops due to no variance: HTS_INDEX_NEWPOS
# drops due to colinearity: TX_NET_NEW (colinear with TX_CURR)
```{r}
site_spread <- mer_png_full %>% select(-HTS_INDEX_NEWPOS, -TX_NET_NEW) # dropping HTS_INDEX_NEWPOS because it has no variance and dropping TX_NET_NEW bc its perfectly colinear with TX_CURR
site_split <- split(site_spread, site_spread$sex)

site_sex <- lapply(site_split, function(x){
  # x <- site_split$Male # for testing one pass through the loop
  # drop observations where most variables are missing and variables where most observations are missing
  obs_count <- apply(x[, 6:ncol(x)], 1, function(y) length(which(!is.na(y)))) #this is the number of indicators reported for that row
  count_present <- apply(x[, 6:ncol(x)], 2, function(y) length(which(!is.na(y)))) #this is the number of rows that reported each indicator
  cols_to_keep <- which(count_present > (nrow(x)*.10))+5
  obs_to_keep <- which(obs_count > 3)
  site_keep <- cbind(x[obs_to_keep, 1:5], x[obs_to_keep, cols_to_keep])

# calculate variance of each indicator; if 0, drop it
# calculate colinearity between variable pairs; if a pair is colinear, drop one of them  
  
  # get sparse mu
  sum_sparse <- colSums(site_keep[, 6:ncol(site_keep)], na.rm = T)
  count_present_keep <- apply(site_keep[, 6:ncol(site_keep)], 2, function(x) length(which(!is.na(x))))
  #count_present_keep <- count_present[cols_to_keep-5]
  mu <- sum_sparse / count_present_keep # make sure this is calculating the right mu
  k <- length(mu)
  
  N <- matrix(0, k, k)
  diag(N) <- count_present_keep
  
  i_mat <- matrix(0, k, k)
  diag(i_mat) <- 1
  
  S <- matrix(0, k, k)
  
  for (i in 1:nrow(site_keep)){
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[6:ncol(site_keep)]))
    yt <- dat[6:ncol(site_keep)][inds]
    yt_mu <- as.matrix(yt - mu[inds])
    
    Hyt <- as.matrix(i_mat[inds, ])
    if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)}
    
    S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
  }
  
  N_sqrt <- sqrt(N)
  diag(N_sqrt) <- 1/(diag(N_sqrt))
  R <- (N_sqrt %*% S %*% N_sqrt)
  
  
  # Try modi package
  site_sex_out <- site_keep
  site_sex_out$MD_sp <- MDmiss(site_sex_out[, 6:ncol(site_sex_out)], center = mu, cov = R)
  cv<-qchisq(.95,df=ncol(site_sex_out)-1)
  site_sex_out$outlier_sex <- ifelse(site_sex_out$MD_sp>cv, 1, 0)
  
  preds_sex <- matrix(data = NA, nrow = nrow(site_keep), ncol = k)
  
  for (i in 1:nrow(site_keep)){
    
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[6:ncol(site_keep)]))
    # yt <- dat[6:ncol(site_keep)][inds]
    
    # loop through inds
    for (j in inds){
      
      # Get Rxtyt
      Rxtyt <- R[j, inds[!(inds %in% j)]]
      # Get Ryt_inv
      Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
      if (length(Ryt) > 1){
      Ryt_inv <- matlib::inv(Ryt)  
      } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
      #Get yt-uyt
      yt <- dat[6:ncol(site_keep)][inds[!(inds %in% j)]]
      yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
      # uxt
      uxt <- mu[j]
      
      # Get estimated value
      preds_sex[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
      
    }
    
    
  }
  
  preds_df_sex <- data.frame(preds_sex)
  names(preds_df_sex) <- paste0("E_", names(site_keep)[6:ncol(site_keep)])
  site_all_sex <- cbind(site_sex_out, preds_df_sex)
  
  # Take the difference between estimate and actual and normalize by dividing by sample variance
  deviation <- abs(site_all_sex[, (ncol(site_keep)+3):ncol(site_all_sex)] - site_all_sex[, 6:ncol(site_keep)])
  deviation <- mapply('/', deviation, diag(R))
  deviation <- data.frame(deviation)
  names(deviation) <- paste0("D_", names(site_keep)[6:ncol(site_keep)])
  site_out_sex <- cbind(site_all_sex, deviation)
  
})

# stack the outputs
site_sex_outliers <- do.call(plyr::rbind.fill, site_sex)
site_sex_outliers <- site_sex_outliers %>%
  select("facility", "ageasentered", "sex", "kp", "facility_type", "HTS_TST", "HTS_TST_NEG", "HTS_TST_POS", "TX_CURR",
         "TX_NEW", "TX_RTT", "HTS_INDEX", "HTS_INDEX_NEWNEG",  "TX_ML",  
         "MD_sp", "outlier_sex", "E_HTS_TST", "E_HTS_TST_NEG", "E_HTS_TST_POS", "E_TX_CURR", "E_TX_NEW", "E_TX_RTT", "E_HTS_INDEX",
         "E_HTS_INDEX_NEWNEG", "E_TX_ML", "D_HTS_TST", "D_HTS_TST_NEG", "D_HTS_TST_POS", "D_TX_CURR",
         "D_TX_NEW", "D_TX_RTT", "D_HTS_INDEX", "D_HTS_INDEX_NEWNEG", "D_TX_ML") 

anomaly_recommender_sex <- site_sex_outliers

write.xlsx(anomaly_recommender_sex, './png_anomaly_recommender_sex.xlsx')

# left join the output table from the sex run to site_spread (join on all five of the unique columns)
site_out_sex_full <- left_join(site_spread[,c("facility", "ageasentered", "sex", "kp", "facility_type")], anomaly_recommender_sex, by=c("facility", "ageasentered", "sex", "kp", "facility_type"))
         
write.xlsx(site_out_sex_full, './png_anomaly_recommender_sex_full.xlsx')

```


# Let's split the data by age (using 5 year age bands) and run on each sub-group ------------------------
# this disaggregation is too small to run 
```{r}
site_spread <- mer_png_full %>% select(-HTS_INDEX_NEWPOS, -HTS_INDEX_NEWNEG, -HTS_INDEX_KNOWNPOS, -TX_NET_NEW)

site_spread <- site_spread %>% 
  mutate(ageasentered = ifelse(ageasentered == "<01", "01-04",
                                ifelse(ageasentered == "<10", "<15",
                                ifelse(ageasentered == "<15", "<15",
                                ifelse(ageasentered == "01-04", "01-04",
                                ifelse(ageasentered == "05-09", "05-09", 
                                ifelse(ageasentered == "10-14", "10-14", 
                                ifelse(ageasentered == "15-19", "15-19",
                                ifelse(ageasentered == "20-24", "20-24",
                                ifelse(ageasentered == "25-29", "25-29",
                                ifelse(ageasentered == "30-34", "30-34",
                                ifelse(ageasentered == "35-39", "35-39",
                                ifelse(ageasentered == "40-44", "40-44",
                                ifelse(ageasentered == "45-49", "45-49",
                                ifelse(ageasentered == "50+", "50+", "Other")))))))))))))))
                        
site_split <- split(site_spread, site_spread$ageasentered)



site_sex <- lapply(site_split, function(x){
  x <- site_split$`05-09` # testing with one of the split tables - MD Miss line is not running, lets try less disag
  # drop observations where most variables are missing and variables where most observations are missing
  obs_count <- apply(x[, 6:ncol(x)], 1, function(y) length(which(!is.na(y))))
  count_present <- apply(x[, 6:ncol(x)], 2, function(y) length(which(!is.na(y))))
  cols_to_keep <- which(count_present > (nrow(x)*.05))+5
  obs_to_keep <- which(obs_count > 2)
  site_keep <- cbind(x[obs_to_keep, 1:5], x[obs_to_keep, cols_to_keep])
  
  # get sparse mu
  sum_sparse <- colSums(site_keep[, 6:ncol(site_keep)], na.rm = T)
  count_present_keep <- count_present[cols_to_keep-5]
  mu <- sum_sparse / count_present_keep # make sure this is calculating the right mu
  k <- length(mu)
  
  N <- matrix(0, k, k)
  diag(N) <- count_present_keep
  
  i_mat <- matrix(0, k, k)
  diag(i_mat) <- 1
  
  S <- matrix(0, k, k)
  
  for (i in 1:nrow(site_keep)){
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[6:ncol(site_keep)]))
    yt <- dat[6:ncol(site_keep)][inds]
    yt_mu <- as.matrix(yt - mu[inds])
    
    Hyt <- as.matrix(i_mat[inds, ])
    if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)}
    
    S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
  }
  
  N_sqrt <- sqrt(N)
  diag(N_sqrt) <- 1/(diag(N_sqrt))
  R <- (N_sqrt %*% S %*% N_sqrt) # det(R) is 0 so we can't run it on a disag this small (15 obs and 9 indicators for 15-19 age group)
  # if det(R) is 0, we have a singular matrix and MDMiss can't invert it 
  
  # Try modi package
  site_sex_out <- site_keep
  site_sex_out$MD_sp <- MDmiss(site_sex_out[, 6:ncol(site_sex_out)], center = mu, cov = R)
  cv<-qchisq(.95,df=ncol(site_sex_out)-1)
  site_sex_out$outlier_sex <- ifelse(site_sex_out$MD_sp>cv, 1, 0)
  
  preds_sex <- matrix(data = NA, nrow = nrow(site_keep), ncol = k)
  
  for (i in 1:nrow(site_keep)){
    
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[6:ncol(site_keep)]))
    # yt <- dat[6:ncol(site_keep)][inds]
    
    # loop through inds
    for (j in inds){
      
      # Get Rxtyt
      Rxtyt <- R[j, inds[!(inds %in% j)]]
      # Get Ryt_inv
      Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
      if (length(Ryt) > 1){
      Ryt_inv <- matlib::inv(Ryt)  
      } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
      #Get yt-uyt
      yt <- dat[6:ncol(site_keep)][inds[!(inds %in% j)]]
      yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
      # uxt
      uxt <- mu[j]
      
      # Get estimated value
      preds_sex[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
      
    }
    
    
  }
  
  preds_df_sex <- data.frame(preds_sex)
  names(preds_df_sex) <- paste0("E_", names(site_keep)[6:ncol(site_keep)])
  site_all_sex <- cbind(site_sex_out, preds_df_sex)
  
  # Take the difference between estimate and actual and normalize by dividing by sample variance
  deviation <- abs(site_all_sex[, (ncol(site_keep)+3):ncol(site_all_sex)] - site_all_sex[, 6:ncol(site_keep)])
  deviation <- mapply('/', deviation, diag(R))
  deviation <- data.frame(deviation)
  names(deviation) <- paste0("D_", names(site_keep)[6:ncol(site_keep)])
  site_out_sex <- cbind(site_all_sex, deviation)
  site_out_sex
  
})

# stack the outputs
site_sex_outliers_fine <- do.call(plyr::rbind.fill, site_sex)
site_sex_outliers_fine <- site_sex_outliers %>%
  select("facility", "ageasentered", "sex", "kp", "facility_type", "HTS_TST", "HTS_TST_NEG", "HTS_TST_POS", "TX_CURR",
         "TX_NEW", "TX_RTT", "HTS_INDEX", "HTS_INDEX_NEWNEG", "HTS_INDEX_NEWPOS", "TX_ML",  
         "MD_sp", "outlier_sex", "E_HTS_TST", "E_HTS_TST_NEG", "E_HTS_TST_POS", "E_TX_CURR", "E_TX_NEW", "E_TX_RTT", "E_HTS_INDEX",
         "E_HTS_INDEX_NEWNEG", "E_HTS_INDEX_NEWPOS", "E_TX_ML", "D_HTS_TST", "D_HTS_TST_NEG", "D_HTS_TST_POS", "D_TX_CURR",
         "D_TX_NEW", "D_TX_RTT", "D_HTS_INDEX", "D_HTS_INDEX_NEWNEG", "D_HTS_INDEX_NEWPOS", "D_TX_ML") 

anomaly_recommender_sex_fine <- site_sex_outliers_fine
         
write.xlsx(site_sex_outliers, './anomaly_recommender_sex_fine.xlsx')
```


# Let's split the data by age (using panorama age bands - <15 and 15+) and run on each sub-group ------------------------
# summary: useful output
# sparsity: cols_to_keep at least 5%
# obs_to_keep using obs_count > 2
# drops due to no variance: HTS_INDEX_NEWPOS, HTS_INDEX_NEWNEG, HTS_INDEX_KNOWNPOS
# drops due to colinearity: TX_NET_NEW (colinear with TX_CURR)
```{r}
site_input <- mer_png_full
site_input <- site_input %>% 
  mutate(age_lifestage = ifelse(ageasentered == "<01", "<15",
                                ifelse(ageasentered == "<10", "<15",
                                ifelse(ageasentered == "<15", "<15",
                                ifelse(ageasentered == "01-04", "<15",
                                ifelse(ageasentered == "05-09", "<15", 
                                ifelse(ageasentered == "10-14", "<15", 
                                ifelse(ageasentered == "15-19", "15+",
                                ifelse(ageasentered == "20-24", "15+",
                                ifelse(ageasentered == "25-29", "15+",
                                ifelse(ageasentered == "30-34", "15+",
                                ifelse(ageasentered == "35-39", "15+",
                                ifelse(ageasentered == "40-44", "15+",
                                ifelse(ageasentered == "45-49", "15+",
                                ifelse(ageasentered == "50+", "15+", "Other")))))))))))))))

site_input <- site_input[,c(1,2,19,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18)] # site_input is what i need to use for the join later

site_spread <- mer_png_full %>% select(-HTS_INDEX_NEWPOS, -TX_NET_NEW, -HTS_INDEX_NEWNEG, -HTS_INDEX_KNOWNPOS) # dropping HTS_INDEX_NEWPOS, HTS_INDEX_NEWNEG, HTS_INDEX_KNOWNPOS because it has no variance and dropping TX_NET_NEW bc its perfectly colinear with TX_CURR
site_spread <- site_spread %>% 
  mutate(age_lifestage = ifelse(ageasentered == "<01", "<15",
                                ifelse(ageasentered == "<10", "<15",
                                ifelse(ageasentered == "<15", "<15",
                                ifelse(ageasentered == "01-04", "<15",
                                ifelse(ageasentered == "05-09", "<15", 
                                ifelse(ageasentered == "10-14", "<15", 
                                ifelse(ageasentered == "15-19", "15+",
                                ifelse(ageasentered == "20-24", "15+",
                                ifelse(ageasentered == "25-29", "15+",
                                ifelse(ageasentered == "30-34", "15+",
                                ifelse(ageasentered == "35-39", "15+",
                                ifelse(ageasentered == "40-44", "15+",
                                ifelse(ageasentered == "45-49", "15+",
                                ifelse(ageasentered == "50+", "15+", "Other")))))))))))))))

site_spread_reorder <- site_spread[,c(1,2,15,3,4,5,6,7,8,9,10,11,12,13,14)] # site_spread_reorder is what I need to use for the join later
site_spread <- site_spread_reorder
site_spread <- site_spread %>% filter(age_lifestage != "NA")
site_spread <- site_spread %>% filter(age_lifestage != "Other")
site_split <- split(site_spread, site_spread$age_lifestage)


site_sex <- lapply(site_split, function(x){
  # x <- site_split$`15+` # for testing one pass through the loop
  # drop observations where most variables are missing and variables where most observations are missing
  obs_count <- apply(x[, 7:ncol(x)], 1, function(y) length(which(!is.na(y)))) #this is the number of indicators reported for that row
  count_present <- apply(x[, 7:ncol(x)], 2, function(y) length(which(!is.na(y)))) #this is the number of rows that reported each indicator
  cols_to_keep <- which(count_present > (nrow(x)*.05))+6
  obs_to_keep <- which(obs_count > 2)
  site_keep <- cbind(x[obs_to_keep, 1:6], x[obs_to_keep, cols_to_keep])
  
  # get sparse mu
  sum_sparse <- colSums(site_keep[, 7:ncol(site_keep)], na.rm = T)
  count_present_keep <- apply(site_keep[, 7:ncol(site_keep)], 2, function(x) length(which(!is.na(x))))
  #count_present_keep <- count_present[cols_to_keep-5]
  mu <- sum_sparse / count_present_keep # make sure this is calculating the right mu
  k <- length(mu)
  
  N <- matrix(0, k, k)
  diag(N) <- count_present_keep
  
  i_mat <- matrix(0, k, k)
  diag(i_mat) <- 1
  
  S <- matrix(0, k, k)
  
  for (i in 1:nrow(site_keep)){
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[7:ncol(site_keep)]))
    yt <- dat[7:ncol(site_keep)][inds]
    yt_mu <- as.matrix(yt - mu[inds])
    
    Hyt <- as.matrix(i_mat[inds, ])
    if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)}
    
    S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
  }
  
  N_sqrt <- sqrt(N)
  diag(N_sqrt) <- 1/(diag(N_sqrt))
  R <- (N_sqrt %*% S %*% N_sqrt)
  
  
  # Try modi package
  site_sex_out <- site_keep
  site_sex_out$MD_sp <- MDmiss(site_sex_out[, 7:ncol(site_sex_out)], center = mu, cov = R)
  cv<-qchisq(.95,df=ncol(site_sex_out)-1)
  site_sex_out$outlier_sex <- ifelse(site_sex_out$MD_sp>cv, 1, 0)
  
  preds_sex <- matrix(data = NA, nrow = nrow(site_keep), ncol = k)
  
  for (i in 1:nrow(site_keep)){
    
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[7:ncol(site_keep)]))
    # yt <- dat[6:ncol(site_keep)][inds]
    
    # loop through inds
    for (j in inds){
      
      # Get Rxtyt
      Rxtyt <- R[j, inds[!(inds %in% j)]]
      # Get Ryt_inv
      Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
      if (length(Ryt) > 1){
      Ryt_inv <- matlib::inv(Ryt)  
      } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
      #Get yt-uyt
      yt <- dat[7:ncol(site_keep)][inds[!(inds %in% j)]]
      yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
      # uxt
      uxt <- mu[j]
      
      # Get estimated value
      preds_sex[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
      
    }
    
    
  }
  
  preds_df_sex <- data.frame(preds_sex)
  names(preds_df_sex) <- paste0("E_", names(site_keep)[7:ncol(site_keep)])
  site_all_sex <- cbind(site_sex_out, preds_df_sex)
  
  # Take the difference between estimate and actual and normalize by dividing by sample variance
  deviation <- abs(site_all_sex[, (ncol(site_keep)+3):ncol(site_all_sex)] - site_all_sex[, 7:ncol(site_keep)])
  deviation <- mapply('/', deviation, diag(R))
  deviation <- data.frame(deviation)
  names(deviation) <- paste0("D_", names(site_keep)[7:ncol(site_keep)])
  site_out_sex <- cbind(site_all_sex, deviation)
  site_out_sex
  
})

# stack the outputs
site_sex_outliers <- do.call(plyr::rbind.fill, site_sex)
site_age_outliers <- site_sex_outliers %>%
  select("facility", "ageasentered", "age_lifestage", "sex", "kp", "facility_type", "HTS_TST", "HTS_TST_NEG", "HTS_TST_POS", "TX_CURR",
         "TX_NEW", "TX_RTT", "HTS_INDEX", "TX_ML",  
         "MD_sp", "outlier_sex", "E_HTS_TST", "E_HTS_TST_NEG", "E_HTS_TST_POS", "E_TX_CURR", "E_TX_NEW", "E_TX_RTT", "E_HTS_INDEX",
         "E_TX_ML", "D_HTS_TST", "D_HTS_TST_NEG", "D_HTS_TST_POS", "D_TX_CURR",
         "D_TX_NEW", "D_TX_RTT", "D_HTS_INDEX",  "D_TX_ML") 

anomaly_recommender_age <- site_age_outliers
         
write.xlsx(site_age_outliers, './png_anomaly_recommender_age.xlsx')

# left join the output table from the sex run to site_spread (join on all five of the unique columns)
site_out_age_full <- left_join(site_input[,c("facility", "ageasentered", "age_lifestage", "sex", "kp", "facility_type")], anomaly_recommender_age, by=c("facility", "ageasentered", "sex", "kp", "facility_type"))
         
write.xlsx(site_out_age_full, './png_anomaly_recommender_age_full.xlsx')

```


# Let's split the data by age (grouped by life stages - 0-14; 15-24; 25-49; 50+) and run on each sub-group ------------------------
# summary: useful output
# sparsity: cols_to_keep at least 5%
# obs_to_keep using obs_count > 2
# drops due to no variance: HTS_INDEX_NEWPOS, HTS_INDEX_NEWNEG, HTS_INDEX_KNOWNPOS
# drops due to colinearity: TX_NET_NEW (colinear with TX_CURR)
```{r}
site_spread <- mer_png_full
site_spread <- site_spread %>% 
  mutate(age_lifestage = ifelse(ageasentered == "<01", "0-14",
                                ifelse(ageasentered == "<10", "0-14",
                                ifelse(ageasentered == "<15", "0-14",
                                ifelse(ageasentered == "01-04", "0-14",
                                ifelse(ageasentered == "05-09", "0-14", 
                                ifelse(ageasentered == "10-14", "0-14", 
                                ifelse(ageasentered == "15-19", "15-24",
                                ifelse(ageasentered == "20-24", "15-24",
                                ifelse(ageasentered == "25-29", "25-49",
                                ifelse(ageasentered == "30-34", "25-49",
                                ifelse(ageasentered == "35-39", "25-49",
                                ifelse(ageasentered == "40-44", "25-49",
                                ifelse(ageasentered == "45-49", "25-49",
                                ifelse(ageasentered == "50+", "50+", "Other")))))))))))))))

site_input <- site_spread

site_input <- site_input[,c(1,2,19,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18)]

site_spread <- site_spread %>% select(-HTS_INDEX_NEWPOS, -TX_NET_NEW, -HTS_INDEX_NEWNEG, -HTS_INDEX_KNOWNPOS) # dropping HTS_INDEX_NEWPOS, HTS_INDEX_NEWNEG, HTS_INDEX_KNOWNPOS because it has no variance and dropping TX_NET_NEW bc its perfectly colinear with TX_CURR
site_spread_reorder <- site_spread[,c(1,2,15,3,4,5,6,7,8,9,10,11,12,13,14)]
site_spread <- site_spread_reorder
site_split <- split(site_spread, site_spread$age_lifestage)

site_sex <- lapply(site_split, function(x){
  # x <- site_split$`50+` # for testing one pass through the loop
  # drop observations where most variables are missing and variables where most observations are missing
  obs_count <- apply(x[, 7:ncol(x)], 1, function(y) length(which(!is.na(y)))) #this is the number of indicators reported for that row
  count_present <- apply(x[, 7:ncol(x)], 2, function(y) length(which(!is.na(y)))) #this is the number of rows that reported each indicator
  cols_to_keep <- which(count_present > (nrow(x)*.05))+6
  obs_to_keep <- which(obs_count > 2)
  site_keep <- cbind(x[obs_to_keep, 1:6], x[obs_to_keep, cols_to_keep])
  
  # get sparse mu
  sum_sparse <- colSums(site_keep[, 7:ncol(site_keep)], na.rm = T)
  count_present_keep <- count_present[cols_to_keep-6]
  mu <- sum_sparse / count_present_keep # make sure this is calculating the right mu
  k <- length(mu)
  
  N <- matrix(0, k, k)
  diag(N) <- count_present_keep
  
  i_mat <- matrix(0, k, k)
  diag(i_mat) <- 1
  
  S <- matrix(0, k, k)
  
  for (i in 1:nrow(site_keep)){
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[7:ncol(site_keep)]))
    yt <- dat[7:ncol(site_keep)][inds]
    yt_mu <- as.matrix(yt - mu[inds])
    
    Hyt <- as.matrix(i_mat[inds, ])
    if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)}
    
    S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
  }
  
  N_sqrt <- sqrt(N)
  diag(N_sqrt) <- 1/(diag(N_sqrt))
  R <- (N_sqrt %*% S %*% N_sqrt) # det(R) for the 50+ disagg is 0 - we cannot use 50+ as one of our groupings
  
  
  # Try modi package
  site_sex_out <- site_keep
  site_sex_out$MD_sp <- MDmiss(site_sex_out[, 7:ncol(site_sex_out)], center = mu, cov = R)
  cv<-qchisq(.95,df=ncol(site_sex_out)-1)
  site_sex_out$outlier_sex <- ifelse(site_sex_out$MD_sp>cv, 1, 0)
  
  preds_sex <- matrix(data = NA, nrow = nrow(site_keep), ncol = k)
  
  for (i in 1:nrow(site_keep)){
    
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[7:ncol(site_keep)]))
    # yt <- dat[6:ncol(site_keep)][inds]
    
    # loop through inds
    for (j in inds){
      
      # Get Rxtyt
      Rxtyt <- R[j, inds[!(inds %in% j)]]
      # Get Ryt_inv
      Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
      if (length(Ryt) > 1){
      Ryt_inv <- matlib::inv(Ryt)  
      } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
      #Get yt-uyt
      yt <- dat[7:ncol(site_keep)][inds[!(inds %in% j)]]
      yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
      # uxt
      uxt <- mu[j]
      
      # Get estimated value
      preds_sex[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
      
    }
    
    
  }
  
  preds_df_sex <- data.frame(preds_sex)
  names(preds_df_sex) <- paste0("E_", names(site_keep)[7:ncol(site_keep)])
  site_all_sex <- cbind(site_sex_out, preds_df_sex)
  
  # Take the difference between estimate and actual and normalize by dividing by sample variance
  deviation <- abs(site_all_sex[, (ncol(site_keep)+3):ncol(site_all_sex)] - site_all_sex[, 7:ncol(site_keep)])
  deviation <- mapply('/', deviation, diag(R))
  deviation <- data.frame(deviation)
  names(deviation) <- paste0("D_", names(site_keep)[7:ncol(site_keep)])
  site_out_age <- cbind(site_all_sex, deviation)
  site_out_age
  
})

# stack the outputs
site_age_lifestage_outliers <- do.call(plyr::rbind.fill, site_sex)
site_age_lifestage_outliers <- site_age_lifestage_outliers %>%
  select("facility", "ageasentered", "age_lifestage", "sex", "kp", "facility_type", "HTS_TST", "HTS_TST_NEG", "HTS_TST_POS", "TX_CURR",
         "TX_NEW", "TX_RTT", "HTS_INDEX",  "TX_ML",  
         "MD_sp", "outlier_sex", "E_HTS_TST", "E_HTS_TST_NEG", "E_HTS_TST_POS", "E_TX_CURR", "E_TX_NEW", "E_TX_RTT", "E_HTS_INDEX",
           "E_TX_ML", "D_HTS_TST", "D_HTS_TST_NEG", "D_HTS_TST_POS", "D_TX_CURR",
         "D_TX_NEW", "D_TX_RTT", "D_HTS_INDEX", "D_TX_ML") 

anomaly_recommender_age_lifestage <- site_age_lifestage_outliers
         
write.xlsx(site_age_lifestage_outliers, './anomaly_recommender_age_lifestage.xlsx')

# left join the output table from the sex run to site_spread (join on all five of the unique columns)
site_out_age_lifestage_full <- left_join(site_input[,c("facility", "ageasentered", "age_lifestage", "sex", "kp", "facility_type")], anomaly_recommender_age_lifestage, by=c("facility", "ageasentered", "sex", "kp", "facility_type"))
         
write.xlsx(site_out_age_lifestage_full, './png_anomaly_recommender_age_lifestage_full.xlsx')
```


# Let's split the data by age (grouped by life stages - 0-14; 15-49; 50+) and run on each sub-group ------------------------
# summary: useful output
# sparsity: cols_to_keep at least 5%
# obs_to_keep using obs_count > 2
# drops due to no variance: HTS_INDEX_NEWPOS, HTS_INDEX_NEWNEG, HTS_INDEX_KNOWNPOS
# drops due to colinearity: TX_NET_NEW (colinear with TX_CURR)
```{r}
site_spread <- mer_png_full
site_spread <- site_spread %>% 
  mutate(age_lifestage = ifelse(ageasentered == "<01", "0-14",
                                ifelse(ageasentered == "<10", "0-14",
                                ifelse(ageasentered == "<15", "0-14",
                                ifelse(ageasentered == "01-04", "0-14",
                                ifelse(ageasentered == "05-09", "0-14", 
                                ifelse(ageasentered == "10-14", "0-14", 
                                ifelse(ageasentered == "15-19", "15-49",
                                ifelse(ageasentered == "20-24", "15-49",
                                ifelse(ageasentered == "25-29", "15-49",
                                ifelse(ageasentered == "30-34", "15-49",
                                ifelse(ageasentered == "35-39", "15-49",
                                ifelse(ageasentered == "40-44", "15-49",
                                ifelse(ageasentered == "45-49", "15-49",
                                ifelse(ageasentered == "50+", "50+", "Other")))))))))))))))

site_input <- site_spread

site_input <- site_input[,c(1,2,19,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18)]

site_spread <- site_spread %>% select(-HTS_INDEX_NEWPOS, -TX_NET_NEW, -HTS_INDEX_NEWNEG, -HTS_INDEX_KNOWNPOS) # dropping HTS_INDEX_NEWPOS, HTS_INDEX_NEWNEG, HTS_INDEX_KNOWNPOS because it has no variance and dropping TX_NET_NEW bc its perfectly colinear with TX_CURR
site_spread_reorder <- site_spread[,c(1,2,15,3,4,5,6,7,8,9,10,11,12,13,14)]
site_spread <- site_spread_reorder
site_split <- split(site_spread, site_spread$age_lifestage)

site_sex <- lapply(site_split, function(x){
  # x <- site_split$`50+` # for testing one pass through the loop
  # drop observations where most variables are missing and variables where most observations are missing
  obs_count <- apply(x[, 7:ncol(x)], 1, function(y) length(which(!is.na(y)))) #this is the number of indicators reported for that row
  count_present <- apply(x[, 7:ncol(x)], 2, function(y) length(which(!is.na(y)))) #this is the number of rows that reported each indicator
  cols_to_keep <- which(count_present > (nrow(x)*.05))+6
  obs_to_keep <- which(obs_count > 2)
  site_keep <- cbind(x[obs_to_keep, 1:6], x[obs_to_keep, cols_to_keep])
  
  # get sparse mu
  sum_sparse <- colSums(site_keep[, 7:ncol(site_keep)], na.rm = T)
  count_present_keep <- count_present[cols_to_keep-6]
  mu <- sum_sparse / count_present_keep # make sure this is calculating the right mu
  k <- length(mu)
  
  N <- matrix(0, k, k)
  diag(N) <- count_present_keep
  
  i_mat <- matrix(0, k, k)
  diag(i_mat) <- 1
  
  S <- matrix(0, k, k)
  
  for (i in 1:nrow(site_keep)){
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[7:ncol(site_keep)]))
    yt <- dat[7:ncol(site_keep)][inds]
    yt_mu <- as.matrix(yt - mu[inds])
    
    Hyt <- as.matrix(i_mat[inds, ])
    if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)}
    
    S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
  }
  
  N_sqrt <- sqrt(N)
  diag(N_sqrt) <- 1/(diag(N_sqrt))
  R <- (N_sqrt %*% S %*% N_sqrt) # det(R) for the 50+ disagg is 0 - we cannot use 50+ as one of our groupings
  
  
  # Try modi package
  site_sex_out <- site_keep
  site_sex_out$MD_sp <- MDmiss(site_sex_out[, 7:ncol(site_sex_out)], center = mu, cov = R)
  cv<-qchisq(.95,df=ncol(site_sex_out)-1)
  site_sex_out$outlier_sex <- ifelse(site_sex_out$MD_sp>cv, 1, 0)
  
  preds_sex <- matrix(data = NA, nrow = nrow(site_keep), ncol = k)
  
  for (i in 1:nrow(site_keep)){
    
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[7:ncol(site_keep)]))
    # yt <- dat[6:ncol(site_keep)][inds]
    
    # loop through inds
    for (j in inds){
      
      # Get Rxtyt
      Rxtyt <- R[j, inds[!(inds %in% j)]]
      # Get Ryt_inv
      Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
      if (length(Ryt) > 1){
      Ryt_inv <- matlib::inv(Ryt)  
      } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
      #Get yt-uyt
      yt <- dat[7:ncol(site_keep)][inds[!(inds %in% j)]]
      yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
      # uxt
      uxt <- mu[j]
      
      # Get estimated value
      preds_sex[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
      
    }
    
    
  }
  
  preds_df_sex <- data.frame(preds_sex)
  names(preds_df_sex) <- paste0("E_", names(site_keep)[7:ncol(site_keep)])
  site_all_sex <- cbind(site_sex_out, preds_df_sex)
  
  # Take the difference between estimate and actual and normalize by dividing by sample variance
  deviation <- abs(site_all_sex[, (ncol(site_keep)+3):ncol(site_all_sex)] - site_all_sex[, 7:ncol(site_keep)])
  deviation <- mapply('/', deviation, diag(R))
  deviation <- data.frame(deviation)
  names(deviation) <- paste0("D_", names(site_keep)[7:ncol(site_keep)])
  site_out_age <- cbind(site_all_sex, deviation)
  site_out_age
  
})

# stack the outputs
site_age_3lifestages_outliers <- do.call(plyr::rbind.fill, site_sex)
site_age_3lifestages_outliers <- site_age_lifestage_outliers %>%
  select("facility", "ageasentered", "age_lifestage", "sex", "kp", "facility_type", "HTS_TST", "HTS_TST_NEG", "HTS_TST_POS", "TX_CURR",
         "TX_NEW", "TX_RTT", "HTS_INDEX",  "TX_ML",  
         "MD_sp", "outlier_sex", "E_HTS_TST", "E_HTS_TST_NEG", "E_HTS_TST_POS", "E_TX_CURR", "E_TX_NEW", "E_TX_RTT", "E_HTS_INDEX",
           "E_TX_ML", "D_HTS_TST", "D_HTS_TST_NEG", "D_HTS_TST_POS", "D_TX_CURR",
         "D_TX_NEW", "D_TX_RTT", "D_HTS_INDEX", "D_TX_ML") 

anomaly_recommender_age_3lifestages <- site_age_3lifestages_outliers
         
write.xlsx(site_age_3lifestages_outliers, './anomaly_recommender_age_3lifestages.xlsx')

# left join the output table from the sex run to site_spread (join on all five of the unique columns)
site_out_age_3lifestages_full <- left_join(site_input[,c("facility", "ageasentered", "age_lifestage", "sex", "kp", "facility_type")], anomaly_recommender_age_3lifestages, by=c("facility", "ageasentered", "sex", "kp", "facility_type"))
         
write.xlsx(site_out_age_3lifestages_full, './png_anomaly_recommender_age_3lifestages_full.xlsx')

```


# Let's split the data by sex and age (grouped by life stages - 0-14; 15-49; 50+) and run on each sub-group ------------------------
# this won't work because the Other.Male disagg doesn't run - can we add a rule where we drop one of the disagg tables if it doesn't run?
```{r}
site_spread <- mer_png_full
site_spread <- site_spread %>% 
  mutate(age_lifestage = ifelse(ageasentered == "<01", "0-14",
                                ifelse(ageasentered == "<10", "0-14",
                                ifelse(ageasentered == "<15", "0-14",
                                ifelse(ageasentered == "01-04", "0-14",
                                ifelse(ageasentered == "05-09", "0-14", 
                                ifelse(ageasentered == "10-14", "0-14", 
                                ifelse(ageasentered == "15-19", "15-49",
                                ifelse(ageasentered == "20-24", "15-49",
                                ifelse(ageasentered == "25-29", "15-49",
                                ifelse(ageasentered == "30-34", "15-49",
                                ifelse(ageasentered == "35-39", "15-49",
                                ifelse(ageasentered == "40-44", "15-49",
                                ifelse(ageasentered == "45-49", "15-49",
                                ifelse(ageasentered == "50+", "50+", "Other")))))))))))))))

site_input <- site_spread

site_input <- site_input[,c(1,2,19,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18)]

site_spread <- site_spread %>% select(-HTS_INDEX_NEWPOS, -TX_NET_NEW, -HTS_INDEX_NEWNEG, -HTS_INDEX_KNOWNPOS) # dropping HTS_INDEX_NEWPOS, HTS_INDEX_NEWNEG, HTS_INDEX_KNOWNPOS because it has no variance and dropping TX_NET_NEW bc its perfectly colinear with TX_CURR
site_spread_reorder <- site_spread[,c(1,2,15,3,4,5,6,7,8,9,10,11,12,13,14)]
site_spread <- site_spread_reorder
site_split <- split(site_spread, list(site_spread$age_lifestage, site_spread$sex))

site_sex <- lapply(site_split, function(x){
  x <- site_split$`Other.Male` # for testing one pass through the loop
  # drop observations where most variables are missing and variables where most observations are missing
  obs_count <- apply(x[, 7:ncol(x)], 1, function(y) length(which(!is.na(y)))) #this is the number of indicators reported for that row
  count_present <- apply(x[, 7:ncol(x)], 2, function(y) length(which(!is.na(y)))) #this is the number of rows that reported each indicator
  cols_to_keep <- which(count_present > (nrow(x)*.05))+6
  obs_to_keep <- which(obs_count > 2)
  site_keep <- cbind(x[obs_to_keep, 1:6], x[obs_to_keep, cols_to_keep])
  
  # get sparse mu
  sum_sparse <- colSums(site_keep[, 7:ncol(site_keep)], na.rm = T)
  count_present_keep <- count_present[cols_to_keep-6]
  mu <- sum_sparse / count_present_keep # make sure this is calculating the right mu
  k <- length(mu)
  
  N <- matrix(0, k, k)
  diag(N) <- count_present_keep
  
  i_mat <- matrix(0, k, k)
  diag(i_mat) <- 1
  
  S <- matrix(0, k, k)
  
  for (i in 1:nrow(site_keep)){
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[7:ncol(site_keep)]))
    yt <- dat[7:ncol(site_keep)][inds]
    yt_mu <- as.matrix(yt - mu[inds])
    
    Hyt <- as.matrix(i_mat[inds, ])
    if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)}
    
    S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
  }
  
  N_sqrt <- sqrt(N)
  diag(N_sqrt) <- 1/(diag(N_sqrt))
  R <- (N_sqrt %*% S %*% N_sqrt) # det(R) for the 50+ disagg is 0 - we cannot use 50+ as one of our groupings
  
  
  # Try modi package
  site_sex_out <- site_keep
  site_sex_out$MD_sp <- MDmiss(site_sex_out[, 7:ncol(site_sex_out)], center = mu, cov = R)
  cv<-qchisq(.95,df=ncol(site_sex_out)-1)
  site_sex_out$outlier_sex <- ifelse(site_sex_out$MD_sp>cv, 1, 0)
  
  preds_sex <- matrix(data = NA, nrow = nrow(site_keep), ncol = k)
  
  for (i in 1:nrow(site_keep)){
    
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[7:ncol(site_keep)]))
    # yt <- dat[6:ncol(site_keep)][inds]
    
    # loop through inds
    for (j in inds){
      
      # Get Rxtyt
      Rxtyt <- R[j, inds[!(inds %in% j)]]
      # Get Ryt_inv
      Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
      if (length(Ryt) > 1){
      Ryt_inv <- matlib::inv(Ryt)  
      } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
      #Get yt-uyt
      yt <- dat[7:ncol(site_keep)][inds[!(inds %in% j)]]
      yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
      # uxt
      uxt <- mu[j]
      
      # Get estimated value
      preds_sex[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
      
    }
    
    
  }
  
  preds_df_sex <- data.frame(preds_sex)
  names(preds_df_sex) <- paste0("E_", names(site_keep)[7:ncol(site_keep)])
  site_all_sex <- cbind(site_sex_out, preds_df_sex)
  
  # Take the difference between estimate and actual and normalize by dividing by sample variance
  deviation <- abs(site_all_sex[, (ncol(site_keep)+3):ncol(site_all_sex)] - site_all_sex[, 7:ncol(site_keep)])
  deviation <- mapply('/', deviation, diag(R))
  deviation <- data.frame(deviation)
  names(deviation) <- paste0("D_", names(site_keep)[7:ncol(site_keep)])
  site_out_age <- cbind(site_all_sex, deviation)
  site_out_age
  
})

# stack the outputs
site_age_3lifestages_outliers <- do.call(plyr::rbind.fill, site_sex)
site_age_3lifestages_outliers <- site_age_lifestage_outliers %>%
  select("facility", "ageasentered", "age_lifestage", "sex", "kp", "facility_type", "HTS_TST", "HTS_TST_NEG", "HTS_TST_POS", "TX_CURR",
         "TX_NEW", "TX_RTT", "HTS_INDEX",  "TX_ML",  
         "MD_sp", "outlier_sex", "E_HTS_TST", "E_HTS_TST_NEG", "E_HTS_TST_POS", "E_TX_CURR", "E_TX_NEW", "E_TX_RTT", "E_HTS_INDEX",
           "E_TX_ML", "D_HTS_TST", "D_HTS_TST_NEG", "D_HTS_TST_POS", "D_TX_CURR",
         "D_TX_NEW", "D_TX_RTT", "D_HTS_INDEX", "D_TX_ML") 

anomaly_recommender_age_3lifestages <- site_age_3lifestages_outliers
         
write.xlsx(site_age_3lifestages_outliers, './anomaly_recommender_age_3lifestages.xlsx')

# left join the output table from the sex run to site_spread (join on all five of the unique columns)
site_out_age_3lifestages_full <- left_join(site_input[,c("facility", "ageasentered", "age_lifestage", "sex", "kp", "facility_type")], anomaly_recommender_age_3lifestages, by=c("facility", "ageasentered", "sex", "kp", "facility_type"))
         
write.xlsx(site_out_age_3lifestages_full, './png_anomaly_recommender_age_3lifestages_full.xlsx')
```


# Let's split the data by facility (clinic vs hospital) and run on each sub-group --------
# summary: useful output
# sparsity: cols_to_keep at least 10%
# obs_to_keep using obs_count > 3
# drops due to no variance: HTS_INDEX_NEWPOS
# drops due to colinearity: TX_NET_NEW (colinear with TX_CURR)
```{r}
site_spread <- mer_png_full %>% select(-HTS_INDEX_NEWPOS, -TX_NET_NEW) # dropping HTS_INDEX_NEWPOS because it has no variance and dropping TX_NET_NEW bc its perfectly colinear with TX_CURR
site_split <- split(site_spread, site_spread$sex)

site_sex <- lapply(site_split, function(x){
  # x <- site_split$Male # for testing one pass through the loop
  # drop observations where most variables are missing and variables where most observations are missing
  obs_count <- apply(x[, 6:ncol(x)], 1, function(y) length(which(!is.na(y)))) #this is the number of indicators reported for that row
  count_present <- apply(x[, 6:ncol(x)], 2, function(y) length(which(!is.na(y)))) #this is the number of rows that reported each indicator
  cols_to_keep <- which(count_present > (nrow(x)*.10))+5
  obs_to_keep <- which(obs_count > 3)
  site_keep <- cbind(x[obs_to_keep, 1:5], x[obs_to_keep, cols_to_keep])

# calculate variance of each indicator; if 0, drop it
# calculate colinearity between variable pairs; if a pair is colinear, drop one of them  
  
  # get sparse mu
  sum_sparse <- colSums(site_keep[, 6:ncol(site_keep)], na.rm = T)
  count_present_keep <- apply(site_keep[, 6:ncol(site_keep)], 2, function(x) length(which(!is.na(x))))
  #count_present_keep <- count_present[cols_to_keep-5]
  mu <- sum_sparse / count_present_keep # make sure this is calculating the right mu
  k <- length(mu)
  
  N <- matrix(0, k, k)
  diag(N) <- count_present_keep
  
  i_mat <- matrix(0, k, k)
  diag(i_mat) <- 1
  
  S <- matrix(0, k, k)
  
  for (i in 1:nrow(site_keep)){
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[6:ncol(site_keep)]))
    yt <- dat[6:ncol(site_keep)][inds]
    yt_mu <- as.matrix(yt - mu[inds])
    
    Hyt <- as.matrix(i_mat[inds, ])
    if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)}
    
    S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
  }
  
  N_sqrt <- sqrt(N)
  diag(N_sqrt) <- 1/(diag(N_sqrt))
  R <- (N_sqrt %*% S %*% N_sqrt)
  
  
  # Try modi package
  site_sex_out <- site_keep
  site_sex_out$MD_sp <- MDmiss(site_sex_out[, 6:ncol(site_sex_out)], center = mu, cov = R)
  cv<-qchisq(.95,df=ncol(site_sex_out)-1)
  site_sex_out$outlier_sex <- ifelse(site_sex_out$MD_sp>cv, 1, 0)
  
  preds_sex <- matrix(data = NA, nrow = nrow(site_keep), ncol = k)
  
  for (i in 1:nrow(site_keep)){
    
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[6:ncol(site_keep)]))
    # yt <- dat[6:ncol(site_keep)][inds]
    
    # loop through inds
    for (j in inds){
      
      # Get Rxtyt
      Rxtyt <- R[j, inds[!(inds %in% j)]]
      # Get Ryt_inv
      Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
      if (length(Ryt) > 1){
      Ryt_inv <- matlib::inv(Ryt)  
      } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
      #Get yt-uyt
      yt <- dat[6:ncol(site_keep)][inds[!(inds %in% j)]]
      yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
      # uxt
      uxt <- mu[j]
      
      # Get estimated value
      preds_sex[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
      
    }
    
    
  }
  
  preds_df_sex <- data.frame(preds_sex)
  names(preds_df_sex) <- paste0("E_", names(site_keep)[6:ncol(site_keep)])
  site_all_sex <- cbind(site_sex_out, preds_df_sex)
  
  # Take the difference between estimate and actual and normalize by dividing by sample variance
  deviation <- abs(site_all_sex[, (ncol(site_keep)+3):ncol(site_all_sex)] - site_all_sex[, 6:ncol(site_keep)])
  deviation <- mapply('/', deviation, diag(R))
  deviation <- data.frame(deviation)
  names(deviation) <- paste0("D_", names(site_keep)[6:ncol(site_keep)])
  site_out_sex <- cbind(site_all_sex, deviation)
  
})

# stack the outputs
site_sex_outliers <- do.call(plyr::rbind.fill, site_sex)
site_sex_outliers <- site_sex_outliers %>%
  select("facility", "ageasentered", "sex", "kp", "facility_type", "HTS_TST", "HTS_TST_NEG", "HTS_TST_POS", "TX_CURR",
         "TX_NEW", "TX_RTT", "HTS_INDEX", "HTS_INDEX_NEWNEG",  "TX_ML",  
         "MD_sp", "outlier_sex", "E_HTS_TST", "E_HTS_TST_NEG", "E_HTS_TST_POS", "E_TX_CURR", "E_TX_NEW", "E_TX_RTT", "E_HTS_INDEX",
         "E_HTS_INDEX_NEWNEG", "E_TX_ML", "D_HTS_TST", "D_HTS_TST_NEG", "D_HTS_TST_POS", "D_TX_CURR",
         "D_TX_NEW", "D_TX_RTT", "D_HTS_INDEX", "D_HTS_INDEX_NEWNEG", "D_TX_ML") 

anomaly_recommender_facility <- site_sex_outliers

write.xlsx(anomaly_recommender_facility, './png_anomaly_recommender_sex.xlsx')

# left join the output table from the sex run to site_spread (join on all five of the unique columns)
site_out_facility_full <- left_join(site_spread[,c("facility", "ageasentered", "sex", "kp", "facility_type")], anomaly_recommender_facility, by=c("facility", "ageasentered", "sex", "kp", "facility_type"))
         
write.xlsx(site_out_facility_full, './png_anomaly_recommender_facility.xlsx')
```


# Let's split the data by key pop vs non key pop and run on each sub-group ------------------------
# summary: useful output
# sparsity: cols_to_keep at least 10%
# obs_to_keep using obs_count > 3
# drops due to no variance: HTS_INDEX_NEWPOS
# drops due to colinearity: TX_NET_NEW (colinear with TX_CURR)
```{r}
site_spread <- mer_png_full %>% select(-HTS_INDEX_NEWPOS, -TX_NET_NEW) # dropping HTS_INDEX_NEWPOS because it has no variance and dropping TX_NET_NEW bc its perfectly colinear with TX_CURR
site_split <- split(site_spread, site_spread$kp)

site_sex <- lapply(site_split, function(x){
  # drop observations where most variables are missing and variables where most observations are missing
  obs_count <- apply(x[, 6:ncol(x)], 1, function(y) length(which(!is.na(y)))) #this is the number of indicators reported for that row
  count_present <- apply(x[, 6:ncol(x)], 2, function(y) length(which(!is.na(y)))) #this is the number of rows that reported each indicator
  cols_to_keep <- which(count_present > (nrow(x)*.10))+5
  obs_to_keep <- which(obs_count > 3)
  site_keep <- cbind(x[obs_to_keep, 1:5], x[obs_to_keep, cols_to_keep])
  
  # get sparse mu
  sum_sparse <- colSums(site_keep[, 6:ncol(site_keep)], na.rm = T)
  count_present_keep <- count_present[cols_to_keep-5]
  mu <- sum_sparse / count_present_keep # make sure this is calculating the right mu
  k <- length(mu)
  
  N <- matrix(0, k, k)
  diag(N) <- count_present_keep
  
  i_mat <- matrix(0, k, k)
  diag(i_mat) <- 1
  
  S <- matrix(0, k, k)
  
  for (i in 1:nrow(site_keep)){
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[6:ncol(site_keep)]))
    yt <- dat[6:ncol(site_keep)][inds]
    yt_mu <- as.matrix(yt - mu[inds])
    
    Hyt <- as.matrix(i_mat[inds, ])
    if(dim(Hyt)[2] == 1){Hyt <- t(Hyt)}
    
    S <- S + (t(Hyt) %*% (t(yt_mu) %*% yt_mu) %*% Hyt)
  }
  
  N_sqrt <- sqrt(N)
  diag(N_sqrt) <- 1/(diag(N_sqrt))
  R <- (N_sqrt %*% S %*% N_sqrt)
  
  
  # Try modi package
  site_sex_out <- site_keep
  site_sex_out$MD_sp <- MDmiss(site_sex_out[, 6:ncol(site_sex_out)], center = mu, cov = R)
  cv<-qchisq(.95,df=ncol(site_sex_out)-1)
  site_sex_out$outlier_sex <- ifelse(site_sex_out$MD_sp>cv, 1, 0)
  
  preds_sex <- matrix(data = NA, nrow = nrow(site_keep), ncol = k)
  
  for (i in 1:nrow(site_keep)){
    
    dat <- site_keep[i, ]
    inds <- which(!is.na(dat[6:ncol(site_keep)]))
    # yt <- dat[6:ncol(site_keep)][inds]
    
    # loop through inds
    for (j in inds){
      
      # Get Rxtyt
      Rxtyt <- R[j, inds[!(inds %in% j)]]
      # Get Ryt_inv
      Ryt <- R[inds[!(inds %in% j)], inds[!(inds %in% j)]]
      if (length(Ryt) > 1){
      Ryt_inv <- matlib::inv(Ryt)  
      } else {Ryt_inv <- 1/Ryt} # if Ryt is scalar, take the inverse of Ryt
    
      #Get yt-uyt
      yt <- dat[6:ncol(site_keep)][inds[!(inds %in% j)]]
      yt_mu <- as.matrix(yt - mu[inds[!(inds %in% j)]])
      # uxt
      uxt <- mu[j]
      
      # Get estimated value
      preds_sex[i,j] <- Rxtyt %*% Ryt_inv %*% t(yt_mu) + uxt
      
    }
    
    
  }
  
  preds_df_sex <- data.frame(preds_sex)
  names(preds_df_sex) <- paste0("E_", names(site_keep)[6:ncol(site_keep)])
  site_all_sex <- cbind(site_sex_out, preds_df_sex)
  
  # Take the difference between estimate and actual and normalize by dividing by sample variance
  deviation <- abs(site_all_sex[, (ncol(site_keep)+3):ncol(site_all_sex)] - site_all_sex[, 6:ncol(site_keep)])
  deviation <- mapply('/', deviation, diag(R))
  deviation <- data.frame(deviation)
  names(deviation) <- paste0("D_", names(site_keep)[6:ncol(site_keep)])
  site_out_sex <- cbind(site_all_sex, deviation)
  site_out_sex
  
})

# stack the outputs
site_kp_outliers <- do.call(plyr::rbind.fill, site_sex)
site_kp_outliers <- site_kp_outliers %>%
  select("facility", "ageasentered", "sex", "kp", "facility_type", "HTS_TST", "HTS_TST_NEG", "HTS_TST_POS", "TX_CURR",
         "TX_NEW", "TX_RTT", "HTS_INDEX", "HTS_INDEX_NEWNEG", "TX_ML",  
         "MD_sp", "outlier_sex", "E_HTS_TST", "E_HTS_TST_NEG", "E_HTS_TST_POS", "E_TX_CURR", "E_TX_NEW", "E_TX_RTT", "E_HTS_INDEX",
         "E_HTS_INDEX_NEWNEG", "E_TX_ML", "D_HTS_TST", "D_HTS_TST_NEG", "D_HTS_TST_POS", "D_TX_CURR",
         "D_TX_NEW", "D_TX_RTT", "D_HTS_INDEX", "D_HTS_INDEX_NEWNEG", "D_TX_ML") 

anomaly_recommender_kp <- site_kp_outliers
         
write.xlsx(site_kp_outliers, './anomaly_recommender_kp.xlsx')

# left join the output table from the sex run to site_spread (join on all five of the unique columns)
site_out_kp_full <- left_join(site_spread[,c("facility", "ageasentered", "sex", "kp", "facility_type")], anomaly_recommender_kp, by=c("facility", "ageasentered", "sex", "kp", "facility_type"))
         
write.xlsx(site_out_kp_full, './png_anomaly_recommender_kp.xlsx')
```
