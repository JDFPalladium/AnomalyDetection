---
title: "MER_Data_Pipeline.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load in libraries
```{r}
library(readr)
library(dplyr)
library(knitr)
library(tidyr)
library(openxlsx)
```


# Prepare the data -------------------
```{r}
# Importing MER data
setwd("C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection")
filepath <- "C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection/"
mer_png_raw <- read.csv(paste0(filepath, "PNG FY20 Q1 MER Data Release for Data.FI_4.13.2021.csv"), stringsAsFactors = FALSE)


# only keep rows for which there is more than one unique value
cols_to_keep <- c(1,2,20,21,23,24,25,27,28,29,30,31,32,33,34,35,36,37,38,39,40,49)
mer_png <- mer_png_raw[, cols_to_keep]

# remove the rows that report on Total Numerator or Total Denominator data
mer_png_full <- mer_png %>% filter(!disaggregate %in% c("Total Numerator", "Total Denominator"),
                                   numeratordenom == "N",
                                   !is.na(qtr1))

# create a column for the key population disaggregate
mer_png_full <- mer_png_full %>% 
  mutate(kp = ifelse(disaggregate == "KeyPop/Result" | disaggregate == "KeyPop/HIVStatus", "Yes", "No"))

# create a column for the facility type disaggregate
mer_png_full <- mer_png_full %>% 
  mutate(facility_type = ifelse(facility == "Gerehu Hospital", "Hospital", "Clinic"))

# covert type of the columns to factor
mer_png_full$facility <- as.factor(mer_png_full$facility)
mer_png_full$indicator <- as.factor(mer_png_full$indicator)
mer_png_full$disaggregate <- as.factor(mer_png_full$disaggregate)
mer_png_full$sex <- as.factor(mer_png_full$sex)
mer_png_full$ageasentered <- as.factor(mer_png_full$ageasentered)
mer_png_full$kp <- as.factor(mer_png_full$kp)
mer_png_full$facility_type <- as.factor(mer_png_full$facility_type)

# group by facility, age, sex, and indicator, and then summarize qtr 1 (before pivot)
mer_png_full <- mer_png_full %>% group_by(facility, ageasentered, sex, indicator, kp, facility_type) %>% 
  summarise(qtr1sum = sum(qtr1, na.rm = TRUE)) 

```


# Full dataset ---------
```{r}
# pivot wider
mer_png_full_tidy <- mer_png_full %>%
  pivot_wider(names_from = "indicator", values_from = "qtr1sum")
mer_png_full_processed <- mer_png_full_tidy

mer_png_full_processed[mer_png_full_processed == 0] <- NA

write.xlsx(mer_png_full_processed, file = "mer_png_full.xlsx")

```


# Exploration (testing to make sure no data is lost after the pivot) ------------
```{r}
# total data reported is 23,958 before pivot
mer_png_test <- mer_png_full
cols_to_keep <- c(9,21)
mer_png_test <- mer_png_test[, cols_to_keep]
mer_png_test[is.na(mer_png_test)] = 0
mer_png_indicator_counts_pre <- mer_png_test %>%
  group_by(indicator) %>%
  summarise_each(funs(sum))

# total data reported is 23,958 after pivot
cols_to_keep <- c(6:20)
mer_png_test_post <- mer_png_full_processed[, cols_to_keep]
mer_png_test_post[is.na(mer_png_test_post)] = 0
mer_png_indicator_counts_post <- colSums(mer_png_test_post)
sum(mer_png_indicator_counts_post)

# run this after and it will equal the number of rows
n_distinct(mer_png_full_processed[,c("facility", "ageasentered", "sex")])

n_distinct(mer_png_full[,c("facility", "ageasentered", "sex", "indicator", "facility_type", "kp")])

```



