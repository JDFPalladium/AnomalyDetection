---
title: "PNG_DQA_File_Prep"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load in libraries --------------------------------
```{r}
library(readr)
library(htmltools)
library(dplyr)
library(knitr)
library(tidyr)
library(modi)
library(htmltools)
library(magrittr)
library(openxlsx)
library(readxl)
library(ggplot2)
```


# Read in the data - TX_NEW ----------------------------
```{r}
setwd("C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection")
filepath <- "C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection/"

png_total_anomaly_recommender_full_DQA <- read_excel("png-2021-07-15_all.xlsx")

png_total_anomaly_recommender_sex_full_DQA <- read_excel('png-2021-07-15_sex.xlsx')

png_total_anomaly_recommender_age_lifestage_full_DQA <- read_excel('png-2021-07-15_age.xlsx')
 
png_DQA_validation_TX_NEW <- read_excel('PNG DQA file ZA_June02_2021_TX_NEW.xlsx')
```

# Merge the data from png_total_anomaly_recommender_full_DQA - TX_NEW ---------
```{r}
cols_to_keep <- c(1,2,3,13,22,31,34,35)
png_total_anomaly_recommender_full_DQA <- png_total_anomaly_recommender_full_DQA[, cols_to_keep]

png_total_anomaly_recommender_full_DQA <- png_total_anomaly_recommender_full_DQA %>% 
  rename(HF = facility,
        Age_group = ageasentered,
        Sex = sex,
        MD_sp_total = MD,
        outlier_sp_total = outlier_sp,
        TX_NEW_N = TX_NEW_N,
        E_TX_NEW_total = E_TX_NEW_N,
        D_TX_NEW_total = D_TX_NEW_N)

png_DQA_validation_TX_NEW$HF <- as.factor(png_DQA_validation_TX_NEW$HF)
png_DQA_validation_TX_NEW$Sex <- as.factor(png_DQA_validation_TX_NEW$Sex)
png_DQA_validation_TX_NEW$Age_group <- as.factor(png_DQA_validation_TX_NEW$Age_group)

png_DQA_14jul2021 <- merge(png_DQA_validation_TX_NEW, png_total_anomaly_recommender_full_DQA, by=c("HF", "Age_group", "Sex"), all.x = TRUE)
```


# Merge the data from png_total_anomaly_recommender_sex_full_DQA - TX_NEW ---------
```{r}
cols_to_keep <- c(1,2,3,13,22,31,34,35)
png_total_anomaly_recommender_sex_full_DQA <- png_total_anomaly_recommender_sex_full_DQA[, cols_to_keep]

png_total_anomaly_recommender_sex_full_DQA <- png_total_anomaly_recommender_sex_full_DQA %>% 
  rename(HF = facility,
        Age_group = ageasentered,
        Sex = sex,
        MD_sp_sex = MD,
        outlier_sex = outlier_sp,
        E_TX_NEW_sex = E_TX_NEW_N,
        D_TX_NEW_sex = D_TX_NEW_N)

png_DQA_14jul2021 <- merge(png_DQA_14jul2021, png_total_anomaly_recommender_sex_full_DQA, by=c("HF", "Age_group", "Sex"), all.x = TRUE)
```


# Merge the data from png_total_anomaly_recommender_age_lifestage_full_DQA - TX_NEW ---------
```{r}
cols_to_keep <- c(1,2,3,13,21,29,31,32) 
png_total_anomaly_recommender_age_lifestage_full_DQA <- png_total_anomaly_recommender_age_lifestage_full_DQA[, cols_to_keep]

png_total_anomaly_recommender_age_lifestage_full_DQA <- png_total_anomaly_recommender_age_lifestage_full_DQA %>% 
  rename(HF = facility,
        Age_group = ageasentered,
        Sex = sex,
        MD_sp_age = MD,
        outlier_age = outlier_sp,
        E_TX_NEW_age = E_TX_NEW_N,
        D_TX_NEW_age = D_TX_NEW_N)


png_DQA_TX_NEW <- merge(png_DQA_14jul2021, png_total_anomaly_recommender_age_lifestage_full_DQA, by=c("HF", "Age_group", "Sex"), all.x = TRUE)
write.xlsx(png_DQA_TX_NEW, file = "png_DQA_TX_NEW_15jul2021.xlsx")
```


# Read in the data - TX_CURR ----------------------------
```{r}
setwd("C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection")
filepath <- "C:/Users/allison.fox/OneDrive - Palladium International, LLC/Desktop/Technical Work/Anomaly Detection/"

png_total_anomaly_recommender_full_DQA <- read_excel("png-2021-07-15_all.xlsx")

png_total_anomaly_recommender_sex_full_DQA <- read_excel('png-2021-07-15_sex.xlsx')

png_total_anomaly_recommender_age_lifestage_full_DQA <- read_excel('png-2021-07-15_age.xlsx')

png_DQA_validation_TX_CURR <- read_excel('PNG DQA file ZA_June02_2021_TX_CURR.xlsx')
```

# Merge the data from png_total_anomaly_recommender_full_DQA - TX_CURR ---------
```{r}
cols_to_keep <- c(1,2,3,11,20,29,34,35)
png_total_anomaly_recommender_full_DQA <- png_total_anomaly_recommender_full_DQA[, cols_to_keep]

png_total_anomaly_recommender_full_DQA <- png_total_anomaly_recommender_full_DQA %>% 
  rename(HF = facility,
        Age_group = ageasentered,
        Sex = sex,
        MD_sp_total = MD,
        TX_CURR_N = TX_CURR_N,
        outlier_sp_total = outlier_sp,
        E_TX_CURR_total = E_TX_CURR_N,
        D_TX_CURR_total = D_TX_CURR_N)

png_DQA_validation_TX_CURR$HF <- as.factor(png_DQA_validation_TX_CURR$HF)
png_DQA_validation_TX_CURR$Sex <- as.factor(png_DQA_validation_TX_CURR$Sex)
png_DQA_validation_TX_CURR$Age_group <- as.factor(png_DQA_validation_TX_CURR$Age_group)

png_DQA_14jul2021 <- merge(png_DQA_validation_TX_CURR, png_total_anomaly_recommender_full_DQA, by=c("HF", "Age_group", "Sex"), all.x = TRUE)
```


# Merge the data from png_total_anomaly_recommender_sex_full_DQA - TX_CURR ---------
```{r}
cols_to_keep <- c(1,2,3,11,20,29,34,35)
png_total_anomaly_recommender_sex_full_DQA <- png_total_anomaly_recommender_sex_full_DQA[, cols_to_keep]

png_total_anomaly_recommender_sex_full_DQA <- png_total_anomaly_recommender_sex_full_DQA %>% 
  rename(HF = facility,
        Age_group = ageasentered,
        Sex = sex,
        MD_sp_sex = MD,
        outlier_sex = outlier_sp,
        E_TX_CURR_sex = E_TX_CURR_N,
        D_TX_CURR_sex = D_TX_CURR_N)

png_DQA_14jul2021 <- merge(png_DQA_14jul2021, png_total_anomaly_recommender_sex_full_DQA, by=c("HF", "Age_group", "Sex"), all.x = TRUE)
```


# Merge the data from png_total_anomaly_recommender_age_lifestage_full_DQA - TX_CURR ---------
```{r}
cols_to_keep <- c(1,2,3,11,19,27,31,32)
png_total_anomaly_recommender_age_lifestage_full_DQA <- png_total_anomaly_recommender_age_lifestage_full_DQA[, cols_to_keep]

png_total_anomaly_recommender_age_lifestage_full_DQA <- png_total_anomaly_recommender_age_lifestage_full_DQA %>% 
  rename(HF = facility,
        Age_group = ageasentered,
        Sex = sex,
        MD_sp_age = MD,
        outlier_age = outlier_sp,
        E_TX_CURR_age = E_TX_CURR_N,
        D_TX_CURR_age = D_TX_CURR_N)


png_DQA_TX_CURR <- merge(png_DQA_14jul2021, png_total_anomaly_recommender_age_lifestage_full_DQA, by=c("HF", "Age_group", "Sex"), all.x = TRUE)
write.xlsx(png_DQA_TX_CURR, file = "png_DQA_TX_CURR_15jul2021.xlsx")
```


# steps taken on png_DQA_TX_NEW_15jul2021 and png_DQA_TX_CURR_15jul2021 to generate covariance vs DQA results
```{r}
#Steps for TX_CURR:	
#1. keep only cells that have DQA concordance values 
#2. remove those observations that do not have estimates from the anomaly work	
#3. Replace all negative estimates for TX_CURR and TX_NEW with zeros	
#4. Calculate the count and % of concordance issues in each comparison of interest	
#5. Present the results on the agreement between pairs	
#6. For any estimates, do not calculate concordance if the estimated value is missing 
#7. This process is done 3 times: once with all values >10, once with all values >30, and once with all values >50

# the file png_DQA_TX_NEW_TX_CURR_15jul2021 shows all intermediary work and the final summary table of results
```

